#include <stdio.h>
#include <string.h>
#include "lib_rent_record.h"
#include "lib_crypto.h"
#include "lib_general.h"
#include <arpa/inet.h>


int str_to_hex(unsigned char *str_data, unsigned char *hex_data, int str_len);

int main(int argc, char *argv[])
{
	int ret = -1, i = 0;
	char rent_str[] = "6B616C71456D35576C53454B417155774D4441774D4441774D4441774D44454A772F665430374C69797453372B676B784E5445784D546B784E4455344363503330394F7934737255752F6F4A4D5455784D5445354D5455784D676B314E416B774D4455774D44414A436A41774D4441774D4441774D4441774D516E443939505473754C4B314C7636435445314D5445784F5445304E54674A772F665430374C69797453372B676B784E5445784D546B784E54457943545530435441774E5441774D416B4B4D4441774D4441774D4441774D4441784363503330394F7934737255752F6F4A4D5455784D5445354D54517A4D516E443939505473754C4B314C7636435445314D5445784F5445304E54634A4D6A594A4D4441314D44417743516F774D4441774D4441774D4441774D44454A772F665430374C69797453372B676B784E5445784D546B784E4455334363503330394F7934737255752F6F4A4D5455784D5445354D5451314F416B78435441774E5441774D416B4B4D4441774D4441774D4441774D4441784363503330394F7934737255752F6F4A4D5455784D5445354D54517A4D516E443939505473754C4B314C7636435445314D5445784F5445304E54634A4D6A594A4D4441314D44417743516F774D4441774D4441774D4441774D44454A772F665430374C69797453372B676B784E5445784D546B784E444D784363503330394F7934737255752F6F4A4D5455784D5445354D54517A4D516B77435441774E5441774D416B4B4D4441774D4441774D4441774D4441784363503330394F7934737255752F6F4A4D5455784D5445354D54517A4D416E443939505473754C4B314C7636435445314D5445784F5445304D7A454A4D516B774D4455774D44414A436A41774D4441774D4441774D4441774D516E443939505473754C4B314C7636435445314D5445784F5445794D54634A772F665430374C69797453372B676B784E5445784D546B784E444D77435449784D776B774D4455774D44414A436A41774D4441774D4441774D4441774D516E443939505473754C4B314C7636435445314D5445784F5445794D54594A772F665430374C69797453372B676B784E5445784D546B784D6A45334354454A4D4441314D44417743516F774D4441774D4441774D4441774D44454A772F665430374C69797453372B676B784E5445784D546B784D6A41794363503330394F7934737255752F6F4A4D5455784D5445354D5449784E516B784D776B774D4455774D44414A43673D3D";

	char hexdata[2048] = {0}, bindata[2048] = {0}, str[2048] = {0};
	unsigned short size = 0;
	
	ret = str_to_hex(&rent_str,&hexdata,strlen(rent_str));
	//lib_str_to_hex(&rent_str,strlen(rent_str),&hexdata);
	
	ret = lib_base64_decode(&hexdata,&bindata);//base64解码
	printf("\n%s\n",&bindata[11]);
	
	memcpy(&size,&bindata[9],2);//租用记录长度
	size = ntohs(size);
	printf("----record num:%d, size:%d-----\n",bindata[8],size);
	
	ret = ParseRentBikeRecord(&bindata,size);//解释中心下发的租用记录

	return 0;
}


int str_to_hex(unsigned char *str_data, unsigned char *hex_data, int str_len)
{
    int i,j,temp_len;
    int tempData;
    unsigned char *o_buf = str_data;
    
    for(i = 0; i < str_len; i++)
    {
        if((o_buf[i] >= '0') && (o_buf[i] <= '9'))         
        {
          	tempData = o_buf[i] - '0';
        }
        else if((o_buf[i] >= 'A') && (o_buf[i] <= 'F'))    
        {
          	tempData = o_buf[i] - 0x37;
        }
        else if((o_buf[i] >= 'a') && (o_buf[i] <= 'f'))   
        {
          	tempData = o_buf[i] - 0x57;
        }
        else
        {
          	return 0;  //illegal data
        }
        o_buf[i] = tempData;
    }
    
    for(temp_len = 0,j = 0; j < i; j += 2)
    {
        hex_data[temp_len++] = (o_buf[j] << 4) | o_buf[j+1];
    }
	
    return temp_len;
}


